if ($response.statusCode !== 200) {
  $done(null);
}

let defalutCity = "é«˜è°­å¸‚";
let ispISP = "Cross-GFW.org";

function City_ValidCheck (para) {
  if (para) {
    return para
  } else {
    return defalutCity
  }
}

function ISP_ValidCheck (para) {
  if (para) {
    return para
  } else {
    return ispISP
  }
}

function Area_check (para) {
  if (para == "ä¸­åæ°‘å›½") {
    return "å°æ¹¾"
  } else {
    return para
  }
}

var flags = new Map([["AC", "ğŸ‡¦ğŸ‡¨"], ["AD", "ğŸ‡¦ğŸ‡©"], ["AE", "ğŸ‡¦ğŸ‡ª"], ["AF", "ğŸ‡¦ğŸ‡«"], ["AG", "ğŸ‡¦ğŸ‡¬"], ["AI", "ğŸ‡¦ğŸ‡®"], ["AL", "ğŸ‡¦ğŸ‡±"], ["AM", "ğŸ‡¦ğŸ‡²"], ["AO", "ğŸ‡¦ğŸ‡´"], ["AQ", "ğŸ‡¦ğŸ‡¶"], ["AR", "ğŸ‡¦ğŸ‡·"], ["AS", "ğŸ‡¦ğŸ‡¸"], ["AT", "ğŸ‡¦ğŸ‡¹"], ["AU", "ğŸ‡¦ğŸ‡º"], ["AW", "ğŸ‡¦ğŸ‡¼"], ["AX", "ğŸ‡¦ğŸ‡½"], ["AZ", "ğŸ‡¦ğŸ‡¿"], ["BA", "ğŸ‡§ğŸ‡¦"], ["BB", "ğŸ‡§ğŸ‡§"], ["BD", "ğŸ‡§ğŸ‡©"], ["BE", "ğŸ‡§ğŸ‡ª"], ["BF", "ğŸ‡§ğŸ‡«"], ["BG", "ğŸ‡§ğŸ‡¬"], ["BH", "ğŸ‡§ğŸ‡­"], ["BI", "ğŸ‡§ğŸ‡®"], ["BJ", "ğŸ‡§ğŸ‡¯"], ["BM", "ğŸ‡§ğŸ‡²"], ["BN", "ğŸ‡§ğŸ‡³"], ["BO", "ğŸ‡§ğŸ‡´"], ["BR", "ğŸ‡§ğŸ‡·"], ["BS", "ğŸ‡§ğŸ‡¸"], ["BT", "ğŸ‡§ğŸ‡¹"], ["BV", "ğŸ‡§ğŸ‡»"], ["BW", "ğŸ‡§ğŸ‡¼"], ["BY", "ğŸ‡§ğŸ‡¾"], ["BZ", "ğŸ‡§ğŸ‡¿"], ["CA", "ğŸ‡¨ğŸ‡¦"], ["CD", "ğŸ‡¨ğŸ‡©"], ["CF", "ğŸ‡¨ğŸ‡«"], ["CG", "ğŸ‡¨ğŸ‡¬"], ["CH", "ğŸ‡¨ğŸ‡­"], ["CI", "ğŸ‡¨ğŸ‡®"], ["CK", "ğŸ‡¨ğŸ‡°"], ["CL", "ğŸ‡¨ğŸ‡±"], ["CM", "ğŸ‡¨ğŸ‡²"], ["CN", "ğŸ‡¨ğŸ‡³"], ["CO", "ğŸ‡¨ğŸ‡´"], ["CP", "ğŸ‡¨ğŸ‡µ"], ["CR", "ğŸ‡¨ğŸ‡·"], ["CU", "ğŸ‡¨ğŸ‡º"], ["CV", "ğŸ‡¨ğŸ‡»"], ["CW", "ğŸ‡¨ğŸ‡¼"], ["CX", "ğŸ‡¨ğŸ‡½"], ["CY", "ğŸ‡¨ğŸ‡¾"], ["CZ", "ğŸ‡¨ğŸ‡¿"], ["DE", "ğŸ‡©ğŸ‡ª"], ["DG", "ğŸ‡©ğŸ‡¬"], ["DJ", "ğŸ‡©ğŸ‡¯"], ["DK", "ğŸ‡©ğŸ‡°"], ["DM", "ğŸ‡©ğŸ‡²"], ["DO", "ğŸ‡©ğŸ‡´"], ["DZ", "ğŸ‡©ğŸ‡¿"], ["EA", "ğŸ‡ªğŸ‡¦"], ["EC", "ğŸ‡ªğŸ‡¨"], ["EE", "ğŸ‡ªğŸ‡ª"], ["EG", "ğŸ‡ªğŸ‡¬"], ["EH", "ğŸ‡ªğŸ‡­"], ["ER", "ğŸ‡ªğŸ‡·"], ["ES", "ğŸ‡ªğŸ‡¸"], ["ET", "ğŸ‡ªğŸ‡¹"], ["EU", "ğŸ‡ªğŸ‡º"], ["FI", "ğŸ‡«ğŸ‡®"], ["FJ", "ğŸ‡«ğŸ‡¯"], ["FK", "ğŸ‡«ğŸ‡°"], ["FM", "ğŸ‡«ğŸ‡²"], ["FO", "ğŸ‡«ğŸ‡´"], ["FR", "ğŸ‡«ğŸ‡·"], ["GA", "ğŸ‡¬ğŸ‡¦"], ["GB", "ğŸ‡¬ğŸ‡§"], ["GD", "ğŸ‡¬ğŸ‡©"], ["GE", "ğŸ‡¬ğŸ‡ª"], ["GF", "ğŸ‡¬ğŸ‡«"], ["GH", "ğŸ‡¬ğŸ‡­"], ["GI", "ğŸ‡¬ğŸ‡®"], ["GL", "ğŸ‡¬ğŸ‡±"], ["GM", "ğŸ‡¬ğŸ‡²"], ["GN", "ğŸ‡¬ğŸ‡³"], ["GP", "ğŸ‡¬ğŸ‡µ"], ["GR", "ğŸ‡¬ğŸ‡·"], ["GT", "ğŸ‡¬ğŸ‡¹"], ["GU", "ğŸ‡¬ğŸ‡º"], ["GW", "ğŸ‡¬ğŸ‡¼"], ["GY", "ğŸ‡¬ğŸ‡¾"], ["HK", "ğŸ‡­ğŸ‡°"], ["HN", "ğŸ‡­ğŸ‡³"], ["HR", "ğŸ‡­ğŸ‡·"], ["HT", "ğŸ‡­ğŸ‡¹"], ["HU", "ğŸ‡­ğŸ‡º"], ["ID", "ğŸ‡®ğŸ‡©"], ["IE", "ğŸ‡®ğŸ‡ª"], ["IL", "ğŸ‡®ğŸ‡±"], ["IM", "ğŸ‡®ğŸ‡²"], ["IN", "ğŸ‡®ğŸ‡³"], ["IR", "ğŸ‡®ğŸ‡·"], ["IS", "ğŸ‡®ğŸ‡¸"], ["IT", "ğŸ‡®ğŸ‡¹"], ["JM", "ğŸ‡¯ğŸ‡²"], ["JO", "ğŸ‡¯ğŸ‡´"], ["JP", "ğŸ‡¯ğŸ‡µ"], ["KE", "ğŸ‡°ğŸ‡ª"], ["KG", "ğŸ‡°ğŸ‡¬"], ["KH", "ğŸ‡°ğŸ‡­"], ["KI", "ğŸ‡°ğŸ‡®"], ["KM", "ğŸ‡°ğŸ‡²"], ["KN", "ğŸ‡°ğŸ‡³"], ["KP", "ğŸ‡°ğŸ‡µ"], ["KR", "ğŸ‡°ğŸ‡·"], ["KW", "ğŸ‡°ğŸ‡¼"], ["KY", "ğŸ‡°ğŸ‡¾"], ["KZ", "ğŸ‡°ğŸ‡¿"], ["LA", "ğŸ‡±ğŸ‡¦"], ["LB", "ğŸ‡±ğŸ‡§"], ["LC", "ğŸ‡±ğŸ‡¨"], ["LI", "ğŸ‡±ğŸ‡®"], ["LK", "ğŸ‡±ğŸ‡°"], ["LR", "ğŸ‡±ğŸ‡·"], ["LS", "ğŸ‡±ğŸ‡¸"], ["LT", "ğŸ‡±ğŸ‡¹"], ["LU", "ğŸ‡±ğŸ‡º"], ["LV", "ğŸ‡±ğŸ‡»"], ["LY", "ğŸ‡±ğŸ‡¾"], ["MA", "ğŸ‡²ğŸ‡¦"], ["MC", "ğŸ‡²ğŸ‡¨"], ["MD", "ğŸ‡²ğŸ‡©"], ["MG", "ğŸ‡²ğŸ‡¬"], ["MH", "ğŸ‡²ğŸ‡­"], ["MK", "ğŸ‡²ğŸ‡°"], ["ML", "ğŸ‡²ğŸ‡±"], ["MM", "ğŸ‡²ğŸ‡²"], ["MN", "ğŸ‡²ğŸ‡³"], ["MO", "ğŸ‡²ğŸ‡´"], ["MP", "ğŸ‡²ğŸ‡µ"], ["MQ", "ğŸ‡²ğŸ‡¶"], ["MR", "ğŸ‡²ğŸ‡·"], ["MS", "ğŸ‡²ğŸ‡¸"], ["MT", "ğŸ‡²ğŸ‡¹"], ["MU", "ğŸ‡²ğŸ‡º"], ["MV", "ğŸ‡²ğŸ‡»"], ["MW", "ğŸ‡²ğŸ‡¼"], ["MX", "ğŸ‡²ğŸ‡½"], ["MY", "ğŸ‡²ğŸ‡¾"], ["MZ", "ğŸ‡²ğŸ‡¿"], ["NA", "ğŸ‡³ğŸ‡¦"], ["NC", "ğŸ‡³ğŸ‡¨"], ["NE", "ğŸ‡³ğŸ‡ª"], ["NF", "ğŸ‡³ğŸ‡«"], ["NG", "ğŸ‡³ğŸ‡¬"], ["NI", "ğŸ‡³ğŸ‡®"], ["NL", "ğŸ‡³ğŸ‡±"], ["NO", "ğŸ‡³ğŸ‡´"], ["NP", "ğŸ‡³ğŸ‡µ"], ["NR", "ğŸ‡³ğŸ‡·"], ["NZ", "ğŸ‡³ğŸ‡¿"], ["OM", "ğŸ‡´ğŸ‡²"], ["PA", "ğŸ‡µğŸ‡¦"], ["PE", "ğŸ‡µğŸ‡ª"], ["PF", "ğŸ‡µğŸ‡«"], ["PG", "ğŸ‡µğŸ‡¬"], ["PH", "ğŸ‡µğŸ‡­"], ["PK", "ğŸ‡µğŸ‡°"], ["PL", "ğŸ‡µğŸ‡±"], ["PM", "ğŸ‡µğŸ‡²"], ["PR", "ğŸ‡µğŸ‡·"], ["PS", "ğŸ‡µğŸ‡¸"], ["PT", "ğŸ‡µğŸ‡¹"], ["PW", "ğŸ‡µğŸ‡¼"], ["PY", "ğŸ‡µğŸ‡¾"], ["QA", "ğŸ‡¶ğŸ‡¦"], ["RE", "ğŸ‡·ğŸ‡ª"], ["RO", "ğŸ‡·ğŸ‡´"], ["RS", "ğŸ‡·ğŸ‡¸"], ["RU", "ğŸ‡·ğŸ‡º"], ["RW", "ğŸ‡·ğŸ‡¼"], ["SA", "ğŸ‡¸ğŸ‡¦"], ["SB", "ğŸ‡¸ğŸ‡§"], ["SC", "ğŸ‡¸ğŸ‡¨"], ["SD", "ğŸ‡¸ğŸ‡©"], ["SE", "ğŸ‡¸ğŸ‡ª"], ["SG", "ğŸ‡¸ğŸ‡¬"], ["SI", "ğŸ‡¸ğŸ‡®"], ["SK", "ğŸ‡¸ğŸ‡°"], ["SL", "ğŸ‡¸ğŸ‡±"], ["SM", "ğŸ‡¸ğŸ‡²"], ["SN", "ğŸ‡¸ğŸ‡³"], ["SR", "ğŸ‡¸ğŸ‡·"], ["ST", "ğŸ‡¸ğŸ‡¹"], ["SV", "ğŸ‡¸ğŸ‡»"], ["SY", "ğŸ‡¸ğŸ‡¾"], ["SZ", "ğŸ‡¸ğŸ‡¿"], ["TC", "ğŸ‡¹ğŸ‡¨"], ["TD", "ğŸ‡¹ğŸ‡©"], ["TG", "ğŸ‡¹ğŸ‡¬"], ["TH", "ğŸ‡¹ğŸ‡­"], ["TJ", "ğŸ‡¹ğŸ‡¯"], ["TL", "ğŸ‡¹ğŸ‡±"], ["TM", "ğŸ‡¹ğŸ‡²"], ["TN", "ğŸ‡¹ğŸ‡³"], ["TO", "ğŸ‡¹ğŸ‡´"], ["TR", "ğŸ‡¹ğŸ‡·"], ["TT", "ğŸ‡¹ğŸ‡¹"], ["TV", "ğŸ‡¹ğŸ‡»"], ["TW", "ğŸ‡¨ğŸ‡³"], ["TZ", "ğŸ‡¹ğŸ‡¿"], ["UA", "ğŸ‡ºğŸ‡¦"], ["UG", "ğŸ‡ºğŸ‡¬"], ["UK", "ğŸ‡¬ğŸ‡§"], ["UM", "ğŸ‡ºğŸ‡²"], ["US", "ğŸ‡ºğŸ‡¸"], ["UY", "ğŸ‡ºğŸ‡¾"], ["UZ", "ğŸ‡ºğŸ‡¿"], ["VA", "ğŸ‡»ğŸ‡¦"], ["VC", "ğŸ‡»ğŸ‡¨"], ["VE", "ğŸ‡»ğŸ‡ª"], ["VG", "ğŸ‡»ğŸ‡¬"], ["VI", "ğŸ‡»ğŸ‡®"], ["VN", "ğŸ‡»ğŸ‡³"], ["VU", "ğŸ‡»ğŸ‡º"], ["WS", "ğŸ‡¼ğŸ‡¸"], ["YE", "ğŸ‡¾ğŸ‡ª"], ["YT", "ğŸ‡¾ğŸ‡¹"], ["ZA", "ğŸ‡¿ğŸ‡¦"], ["ZM", "ğŸ‡¿ğŸ‡²"], ["ZW", "ğŸ‡¿ğŸ‡¼"]])

const valueFormat = (original, newValue) => {
  if (original.includes(newValue)) {
    return ''
  }
  return newValue ? ` ${newValue}` : ''
}

const hkFormat = {
  "Central and Western": "ä¸­è¥¿å€",
  "Central and Western District": "ä¸­è¥¿å€",
  "Eastern": "æ±å€",
  "Eastern District": "æ±å€",
  "Southern": "å—å€",
  "Southern District": "å—å€",
  "Wan Chai": "ç£ä»”å€",
  "Wan Chai District": "ç£ä»”å€",
  "Kowloon City": "ä¹é¾åŸå€",
  "Kowloon City District": "ä¹é¾åŸå€",
  "Kowloon": "ä¹é¾",
  "Kwun Tong": "è§€å¡˜å€",
  "Kwun Tong District": "è§€å¡˜å€",
  "Sham Shui Po": "æ·±æ°´åŸ—å€",
  "Sham Shui Po District": "æ·±æ°´åŸ—å€",
  "Wong Tai Sin": "é»ƒå¤§ä»™å€",
  "Wong Tai Sin District": "é»ƒå¤§ä»™å€",
  "Yau Tsim Mong": "æ²¹å°–æ—ºå€",
  "Yau Tsim Mong District": "æ²¹å°–æ—ºå€",
  "Yau Ma Tei": "æ²¹éº»åœ°",
  "Tsim Sha Tsui": "å°–æ²™å’€",
  "Mong Kok": "æ—ºè§’",
  "Islands": "é›¢å³¶å€",
  "Islands District": "é›¢å³¶å€",
  "Kwai Tsing": "è‘µé’å€",
  "Kwai Tsing District": "è‘µé’å€",
  "North": "åŒ—å€",
  "North District": "åŒ—å€",
  "Sai Kung": "è¥¿è²¢å€",
  "Sai Kung District": "è¥¿è²¢å€",
  "Sha Tin": "æ²™ç”°å€",
  "Sha Tin District": "æ²™ç”°å€",
  "Tai Po": "å¤§åŸ”å€",
  "Tai Po District": "å¤§åŸ”å€",
  "Tsuen Wan": "èƒç£å€",
  "Tsuen Wan District": "èƒç£å€",
  "Tuen Mun": "å±¯é–€å€",
  "Tuen Mun District": "å±¯é–€å€",
  "Yuen Long": "å…ƒæœ—å€",
  "Yuen Long District": "å…ƒæœ—å€",
  "Tai Wai": "å¤§åœ",
  "Tseung Kwan O": "å°‡è»æ¾³",
  "Tung Chung": "æ±æ¶Œ",
  "è‡ºç£çœ or å°ç£çœ": "ğŸ‡¨ğŸ‡³"
}

let body = $response.body;

let obj = JSON.parse(body);

const cityFormat = hkFormat[obj.city] || obj.city

let title = `${flags.get(obj['countryCode'])} ${Area_check(obj['country'])}${valueFormat(obj.country, cityFormat)}${valueFormat(cityFormat, hkFormat[obj.regionName] || obj.regionName)}`

let subtitle = `ğŸŒ ${obj.as.split(' ')[0]} â‡’ ${obj.query}`;

let ip = obj['query'];

let description = `åœ°åŒº: ${title}
æœåŠ¡å•†: ${obj['isp']}
å®šä½: [ ${obj["lat"]},${obj["lon"]} ]
IP: ${obj['query']}
æ—¶åŒº: ${obj['timezone']}
åŸå§‹æ•°æ®: ${JSON.stringify(obj, null, 2)}`;

$done({ title, subtitle, ip, description });